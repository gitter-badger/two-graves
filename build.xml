<?xml version="1.0" ?>
<!-- 
The MIT License (MIT)

Copyright (c) 2014 Robert Winslow Dalpe

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
-->
<project name="barblich-module" basedir=".">
  <!-- BEGIN PROPERTY DEFINITIONS -->

  <property file="build.properties" />

  <!-- END PROPERTY DEFINITIONS -->



  <!-- BEGIN ADDITIONAL LIBRARIES AND CLASSPATH DEFINITIONS -->

  <path id="lib.xslt.classpath">
    <pathelement path="${lib}/${lib.jing}/bin/*" />
  </path>

  <taskdef resource="net/sf/antcontrib/antlib.xml">
    <classpath>
      <pathelement location="${lib}/${lib.ant-contrib}/${lib.ant-contrib.jar}" />
    </classpath>
  </taskdef>

  <!-- END ADDITIONAL LIBRARIES AND CLASSPATH DEFINITIONS -->



  <!-- BEGIN PUBLIC TARGETS -->

  <target name="build.all"
          description="Create all available output formats"
          depends="clean,validate,-do-build.pdf,-do-build.html.single,-do-build.html.chunked,-do-build.epub" />

  <target name="build.pdf" description="Create PDF output" depends="-clean.pdf,validate">
    <antcall target="-do-build.pdf" />
  </target>

  <target name="build.html.single"
          description="Create HTML output in a single file"
          depends="-clean.html.single,validate">
    <antcall target="-do-build.html.single" />
  </target>

  <target name="build.html.chunked"
          description="Create HTML output with separate files per major DocBook part"
          depends="-clean.html.chunked,validate">
    <antcall target="-do-build.html.chunked" />
  </target>

  <target name="build.epub" description="Create EPUB output" depends="-clean.epub,validate">
    <antcall target="-do-build.epub" />
  </target>

  <target name="validate"
          description="Validate all DocBook documents"
          depends="getlibs,-clean.validation">
    <antcall target="-do-validate" />
  </target>

  <target name="clean" description="Remove all output and build artifacts">
    <delete dir="${outputdir}" />
  </target>

  <target name="cleanlibs" description="Remove all lib files that can be safely re-downloaded">
    <delete dir="${lib}/${lib.docbook}" />
    <delete file="${lib}/${lib.docbook.zip}" />
    <delete dir="${lib}/${lib.docbook.stylesheets}" />
    <delete file="${lib}/${lib.docbook.stylesheets.zip}" />
    <delete dir="${lib}/${lib.jing}" />
    <delete file="${lib}/${lib.jing.zip}" />
    <delete dir="${lib}/${lib.fop}" />
    <delete file="${lib}/${lib.fop.zip}" />
  </target>

  <target name="getlibs" description="Retrieve all necessary lib files for building">
    <mkdir dir="${lib}" />

    <get dest="${lib}/" src="${lib.jing.zip.url}" skipexisting="true" />
    <unzip dest="${lib}/" src="${lib}/${lib.jing.zip}" overwrite="false" />
    <get dest="${lib}/" src="${lib.docbook.zip.url}" skipexisting="true" />
    <unzip dest="${lib}/" src="${lib}/${lib.docbook.zip}" overwrite="false" />
    <get dest="${lib}/${lib.docbook.stylesheets.zip}"
         src="${lib.docbook.stylesheets.zip.url}"
         skipexisting="true" />
    <unzip dest="${lib}/" src="${lib}/${lib.docbook.stylesheets.zip}" overwrite="false" />
    <get dest="${lib}/" src="${lib.fop.zip.url}" skipexisting="true" />
    <unzip dest="${lib}/" src="${lib}/${lib.fop.zip}" overwrite="false" />
    <chmod perm="u+x" file="${lib}/${lib.fop}/fop" />
  </target>

  <!-- END PUBLIC TARGETS -->



  <!-- BEGIN PRIVATE TARGETS -->
  <!-- PDF -->
  <target name="-do-build.pdf">
    <foreach target="-build-one.pdf" param="toplevelBookName" list="${src.toplevel-books}" />
  </target>
  <target name="-build-one.pdf">
    <mkdir dir="${outputdir}/${outputdir.fo}" />
    <mkdir dir="${outputdir}/${outputdir.pdf}" />
    <mkdir dir="${outputdir}/${outputdir.fo}/${toplevelBookName}" />
    <mkdir dir="${outputdir}/${outputdir.pdf}/${toplevelBookName}" />

    <java classpathref="lib.xslt.classpath"
          fork="true"
          failonerror="true"
          classname="com.icl.saxon.StyleSheet">
      <sysproperty key="javax.xml.parsers.SAXParserFactory"
                   value="org.apache.xerces.jaxp.SAXParserFactoryImpl" />
      <sysproperty key="org.apache.xerces.xni.parser.XMLParserConfiguration"
                   value="org.apache.xerces.parsers.XIncludeParserConfiguration" />
      <arg value="-o" />
      <arg value="${outputdir}/${outputdir.fo}/${toplevelBookName}/${toplevelBookName}.fo" />
      <arg file="${src}/${toplevelBookName}/${toplevelBookName}.xml" />
      <arg file="${lib}/fo-customizations.xsl" />
      <arg value="toc.indent.width=16" />
      <arg value="fop1.extensions=1" />
      <arg value="use.svg=1" />
      <arg value="email.delimiters.enabled=0" />
      <arg value="email.mailto.enabled=1" />
      <arg value="hyphenate=true" />
      <arg value="column.count.body=2" />
      <arg value="body.start.indent=0pt" />
    </java>

    <if>
      <os family="windows" />
      <then>
        <exec resolveexecutable="true" executable="${lib}/${lib.fop}/fop.cmd">
          <arg value="-fo" />
          <arg value="${outputdir}/${outputdir.fo}/${toplevelBookName}/${toplevelBookName}.fo" />
          <arg value="-pdf" />
          <arg value="${outputdir}/${outputdir.pdf}/${toplevelBookName}/${toplevelBookName}.pdf" />
        </exec>
      </then>
      <else>
        <exec resolveexecutable="true" executable="${lib}/${lib.fop}/fop">
          <arg value="-fo" />
          <arg value="${outputdir}/${outputdir.fo}/${toplevelBookName}/${toplevelBookName}.fo" />
          <arg value="-pdf" />
          <arg value="${outputdir}/${outputdir.pdf}/${toplevelBookName}/${toplevelBookName}.pdf" />
        </exec>
      </else>
    </if>
  </target>
  <target name="-clean.pdf">
    <delete dir="${outputdir}/${outputdir.fo}/" />
    <delete dir="${outputdir}/${outputdir.pdf}/" />
  </target>

  <!-- HTML.SINGLE -->
  <target name="-do-build.html.single">
    <foreach target="-build-one.html.single"
             param="toplevelBookName"
             list="${src.toplevel-books}" />
  </target>
  <target name="-build-one.html.single">
    <mkdir dir="${outputdir}/${outputdir.html}/${outputdir.html.single}/${toplevelBookName}" />

    <java classpathref="lib.xslt.classpath"
          fork="true"
          failonerror="true"
          classname="com.icl.saxon.StyleSheet">
      <sysproperty key="javax.xml.parsers.SAXParserFactory"
                   value="org.apache.xerces.jaxp.SAXParserFactoryImpl" />
      <sysproperty key="org.apache.xerces.xni.parser.XMLParserConfiguration"
                   value="org.apache.xerces.parsers.XIncludeParserConfiguration" />
      <arg value="-o" />
      <arg value="${outputdir}/${outputdir.html}/${outputdir.html.single}/${toplevelBookName}/index.html" />
      <arg file="${src}/${toplevelBookName}/${toplevelBookName}.xml" />
      <arg file="${lib}/${lib.docbook.stylesheets}/html/docbook.xsl" />
      <arg value="html.stylesheet=${src.html.single.cssfile} ${src.html.single.printcssfile}" />
    </java>

    <copy file="${src}/${src.html.single.cssfiledir}/${src.html.single.cssfile}"
          todir="${outputdir}/${outputdir.html}/${outputdir.html.single}/${toplevelBookName}" />
    <copy file="${src}/${src.html.single.cssfiledir}/${src.html.single.printcssfile}"
          todir="${outputdir}/${outputdir.html}/${outputdir.html.single}/${toplevelBookName}" />
  </target>
  <target name="-clean.html.single">
    <delete dir="${outputdir}/${outputdir.html}/${outputdir.html.single}/" />
  </target>

  <!-- HTML.CHUNKED -->
  <target name="-do-build.html.chunked">
    <foreach target="-build-one.html.chunked"
             param="toplevelBookName"
             list="${src.toplevel-books}" />
  </target>
  <target name="-build-one.html.chunked">
    <mkdir dir="${outputdir}/${outputdir.html}/${outputdir.html.chunked}/${toplevelBookName}" />

    <java classpathref="lib.xslt.classpath"
          fork="true"
          failonerror="true"
          classname="com.icl.saxon.StyleSheet">
      <sysproperty key="javax.xml.parsers.SAXParserFactory"
                   value="org.apache.xerces.jaxp.SAXParserFactoryImpl" />
      <sysproperty key="org.apache.xerces.xni.parser.XMLParserConfiguration"
                   value="org.apache.xerces.parsers.XIncludeParserConfiguration" />
      <arg value="-o" />
      <arg value="${outputdir}/${outputdir.html}/${outputdir.html.chunked}/${toplevelBookName}/index.html" />
      <arg file="${src}/${toplevelBookName}/${toplevelBookName}.xml" />
      <arg file="${lib}/${lib.docbook.stylesheets}/html/chunk.xsl" />
      <arg value="base.dir=${outputdir}/${outputdir.html}/${outputdir.html.chunked}/${toplevelBookName}/" />
      <arg value="html.stylesheet=${src.html.single.cssfile} ${src.html.single.printcssfile}" />
    </java>

    <copy file="${src}/${src.html.single.cssfiledir}/${src.html.single.cssfile}"
          todir="${outputdir}/${outputdir.html}/${outputdir.html.chunked}/${toplevelBookName}" />
    <copy file="${src}/${src.html.single.cssfiledir}/${src.html.single.printcssfile}"
          todir="${outputdir}/${outputdir.html}/${outputdir.html.chunked}/${toplevelBookName}" />

    <!-- it makes an empty file in the output directory that we don't want -->
    <delete file="${outputdir}/${outputdir.html}/${outputdir.html.chunked}/${toplevelBookName}/${toplevelBookName}.html" />
  </target>
  <target name="-clean.html.chunked">
    <delete dir="${outputdir}/${outputdir.html}/${outputdir.html.chunked}/" />
  </target>

  <!-- EPUB -->
  <target name="-do-build.epub">
    <foreach target="-build-one.epub" param="toplevelBookName" list="${src.toplevel-books}" />
  </target>
  <target name="-build-one.epub">
    <mkdir dir="${outputdir}/${outputdir.epub}/${toplevelBookName}" />

    <java classpathref="lib.xslt.classpath"
          fork="true"
          failonerror="true"
          classname="com.icl.saxon.StyleSheet">
      <sysproperty key="javax.xml.parsers.SAXParserFactory"
                   value="org.apache.xerces.jaxp.SAXParserFactoryImpl" />
      <sysproperty key="org.apache.xerces.xni.parser.XMLParserConfiguration"
                   value="org.apache.xerces.parsers.XIncludeParserConfiguration" />
      <arg file="${src}/${toplevelBookName}/${toplevelBookName}.xml" />
      <arg file="${lib}/${lib.docbook.stylesheets}/epub3/chunk.xsl" />
      <arg value="base.dir=${outputdir}/${outputdir.epub}/${toplevelBookName}/OEBPS/" />
    </java>

    <zip basedir="${outputdir}/${outputdir.epub}/${toplevelBookName}/"
         destfile="${outputdir}/${outputdir.epub}/${toplevelBookName}/${toplevelBookName}.epub"
         compress="true" />
  </target>
  <target name="-clean.epub">
    <delete dir="${outputdir}/${outputdir.epub}/" />
  </target>

  <!-- VALIDATION -->
  <target name="-do-validate">
    <antcall target="createschematronvalidationsheet" />
    <foreach target="-validate-one" param="toplevelBookName" list="${src.toplevel-books}" />
  </target>

  <target name="createschematronvalidationsheet">
    <mkdir dir="${outputdir}/${outputdir.validation}" />

    <java classpathref="lib.xslt.classpath"
          fork="true"
          failonerror="true"
          classname="com.icl.saxon.StyleSheet">
      <sysproperty key="javax.xml.parsers.SAXParserFactory"
                   value="org.apache.xerces.jaxp.SAXParserFactoryImpl" />
      <sysproperty key="org.apache.xerces.xni.parser.XMLParserConfiguration"
                   value="org.apache.xerces.parsers.XIncludeParserConfiguration" />
      <arg value="-o" />
      <arg value="${outputdir}/${outputdir.validation}/schematronvalidation.xsl" />
      <arg file="${lib}/${lib.docbook}/sch/docbook.sch" />
      <arg file="${lib}/${lib.schematron}/schematron-basic.xsl" />
    </java>
  </target>

  <target name="-validate-one">
    <mkdir dir="${outputdir}/${outputdir.validation}" />

    <java jar="${lib}/${lib.jing}/bin/jing.jar"
          classpathref="lib.xslt.classpath"
          fork="true"
          failonerror="true">
      <sysproperty key="javax.xml.parsers.DocumentBuilderFactory"
                   value="org.apache.xerces.jaxp.DocumentBuilderFactoryImpl" />
      <sysproperty key="javax.xml.parsers.SAXParserFactory"
                   value="org.apache.xerces.jaxp.SAXParserFactoryImpl" />
      <sysproperty key="org.apache.xerces.xni.parser.XMLParserConfiguration"
                   value="org.apache.xerces.parsers.XIncludeParserConfiguration" />
      <arg file="${lib}/${lib.docbook}/rng/docbook.rng" />
      <arg file="${src}/${toplevelBookName}/${toplevelBookName}.xml" />
    </java>

    <java classpathref="lib.xslt.classpath"
          fork="true"
          failonerror="true"
          classname="com.icl.saxon.StyleSheet">
      <sysproperty key="javax.xml.parsers.SAXParserFactory"
                   value="org.apache.xerces.jaxp.SAXParserFactoryImpl" />
      <sysproperty key="org.apache.xerces.xni.parser.XMLParserConfiguration"
                   value="org.apache.xerces.parsers.XIncludeParserConfiguration" />
      <arg value="-o" />
      <arg value="${outputdir}/${outputdir.validation}/schematronerrors.txt" />
      <arg file="${src}/${toplevelBookName}/${toplevelBookName}.xml" />
      <arg file="${outputdir}/${outputdir.validation}/schematronvalidation.xsl" />
    </java>

    <fileset id="failure.file" file="${outputdir}/${outputdir.validation}/schematronerrors.txt">
      <size when="more" value="0" />
    </fileset>

    <echo />

    <if>
      <resourcecount when="greater" count="0" refid="failure.file" />
      <then>
        <echo>Schematron validation errors...</echo>
        <echo />
        <concat>
          <fileset refid="failure.file" />
        </concat>
        <fail message="Schematron validation errors..." />
      </then>
    </if>
  </target>
  <target name="-clean.validation">
    <delete dir="${outputdir}/${outputdir.validation}" />
  </target>

  <!-- END PRIVATE TARGETS -->
</project>